<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Well Testing Community</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container nav-container">
            <a href="index.html" class="logo">
                <div class="logo-icon">W</div>
                <span class="logo-text">Well Testing</span>
            </a>

            <div class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="ask.html" class="nav-link">Ask Question</a>
                <a href="profile.html" class="nav-link">Profile</a>
                <a href="admin.html" class="nav-link active">Admin</a>
                <button class="nav-link btn-danger" id="logoutNavBtn" style="display: none;">Sign Out</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container main-content">
        <div id="accessDenied" class="warning-message" style="display: none;">
            <h3>Access Denied</h3>
            <p>You must be an admin to access this page. <a href="index.html">Return to Home</a></p>
        </div>

        <div id="adminPanel" style="display: none;">
            <h1 class="page-title">Admin Panel</h1>
            <p class="page-subtitle">Manage community content and users</p>

            <!-- Statistics -->
            <div class="profile-stats">
                <div class="stat-card">
                    <div class="stat-icon">‚ùì</div>
                    <div class="stat-value" id="totalQuestions">0</div>
                    <div class="stat-label">Total Questions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí¨</div>
                    <div class="stat-value" id="totalAnswers">0</div>
                    <div class="stat-label">Total Answers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="profile-tabs">
                <button class="tab-btn active" data-tab="questions">All Questions</button>
                <button class="tab-btn" data-tab="answers">All Answers</button>
                <button class="tab-btn" data-tab="users">Users</button>
            </div>

            <!-- Questions Tab -->
            <div class="tab-content active" id="questionsTab">
                <div id="allQuestionsLoading" class="loading-indicator-small">
                    <div class="spinner-small"></div>
                </div>
                <div id="allQuestionsContainer" class="questions-list" style="display: none;"></div>
            </div>

            <!-- Answers Tab -->
            <div class="tab-content" id="answersTab">
                <div id="allAnswersLoading" class="loading-indicator-small">
                    <div class="spinner-small"></div>
                </div>
                <div id="allAnswersContainer" class="answers-list" style="display: none;"></div>
            </div>

            <!-- Users Tab -->
            <div class="tab-content" id="usersTab">
                <div id="allUsersLoading" class="loading-indicator-small">
                    <div class="spinner-small"></div>
                </div>
                <div id="allUsersContainer" class="profile-items" style="display: none;"></div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2026 Well Testing Community. All rights reserved.</p>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Custom Scripts -->
    <script src="js/auth.js"></script>
    <script src="js/firestore.js"></script>

    <script>
        const accessDenied = document.getElementById('accessDenied');
        const adminPanel = document.getElementById('adminPanel');

        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            const userDataResult = await getUserData(user.uid);
            if (userDataResult.success && userDataResult.userData.role === 'admin') {
                accessDenied.style.display = 'none';
                adminPanel.style.display = 'block';
                loadAdminData();
            } else {
                accessDenied.style.display = 'block';
                adminPanel.style.display = 'none';
            }
        });

        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetTab = btn.getAttribute('data-tab');

                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));

                btn.classList.add('active');
                document.getElementById(targetTab + 'Tab').classList.add('active');
            });
        });

        async function loadAdminData() {
            await loadAllQuestions();
            await loadAllAnswers();
            await loadAllUsers();
            await loadStats();
        }

        async function loadAllQuestions() {
            const container = document.getElementById('allQuestionsContainer');
            const loading = document.getElementById('allQuestionsLoading');

            try {
                const snapshot = await db.collection('questions').orderBy('createdAt', 'desc').get();
                const questions = [];
                snapshot.forEach(doc => {
                    questions.push({ id: doc.id, ...doc.data() });
                });

                loading.style.display = 'none';
                container.style.display = 'block';

                container.innerHTML = questions.map(q => `
                    <div class="question-card">
                        <h3 class="question-card-title">
                            <a href="question.html?id=${q.id}">${escapeHtml(q.title)}</a>
                        </h3>
                        <p class="question-card-description">${escapeHtml(q.description)}</p>
                        <div class="question-card-footer">
                            <div class="question-meta">
                                <span class="meta-item">By <strong>${escapeHtml(q.authorName)}</strong></span>
                                <span class="meta-item">${formatDate(q.createdAt)}</span>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="adminDeleteQuestion('${q.id}')">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading questions:', error);
            }
        }

        async function loadAllAnswers() {
            const container = document.getElementById('allAnswersContainer');
            const loading = document.getElementById('allAnswersLoading');

            try {
                const snapshot = await db.collection('answers').orderBy('createdAt', 'desc').limit(50).get();
                const answers = [];

                for (const doc of snapshot.docs) {
                    const answerData = doc.data();
                    const questionDoc = await db.collection('questions').doc(answerData.questionId).get();
                    answers.push({
                        id: doc.id,
                        ...answerData,
                        questionTitle: questionDoc.exists ? questionDoc.data().title : 'Deleted Question'
                    });
                }

                loading.style.display = 'none';
                container.style.display = 'block';

                container.innerHTML = answers.map(a => `
                    <div class="answer-card">
                        <div class="answer-header">
                            <div class="question-meta">
                                <span class="meta-item">By <strong>${escapeHtml(a.authorName)}</strong></span>
                                <span class="meta-item">On: <a href="question.html?id=${a.questionId}">${escapeHtml(a.questionTitle)}</a></span>
                                <span class="meta-item">${formatDate(a.createdAt)}</span>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="adminDeleteAnswer('${a.id}', '${a.questionId}')">Delete</button>
                        </div>
                        <div class="answer-content">${escapeHtml(a.content.substring(0, 200))}${a.content.length > 200 ? '...' : ''}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading answers:', error);
            }
        }

        async function loadAllUsers() {
            const container = document.getElementById('allUsersContainer');
            const loading = document.getElementById('allUsersLoading');

            try {
                const snapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
                const users = [];
                snapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });

                loading.style.display = 'none';
                container.style.display = 'block';

                container.innerHTML = users.map(u => `
                    <div class="question-card">
                        <h3 class="question-card-title">${escapeHtml(u.name)}</h3>
                        <div class="question-meta">
                            <span class="meta-item">Email: ${escapeHtml(u.email)}</span>
                            <span class="meta-item">Role: ${escapeHtml(u.role)}</span>
                            <span class="meta-item">Joined: ${formatDate(u.createdAt)}</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function loadStats() {
            try {
                const questionsSnapshot = await db.collection('questions').get();
                const answersSnapshot = await db.collection('answers').get();
                const usersSnapshot = await db.collection('users').get();

                document.getElementById('totalQuestions').textContent = questionsSnapshot.size;
                document.getElementById('totalAnswers').textContent = answersSnapshot.size;
                document.getElementById('totalUsers').textContent = usersSnapshot.size;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        window.adminDeleteQuestion = async function(questionId) {
            if (confirm('Are you sure you want to delete this question and all its answers?')) {
                const result = await deleteQuestion(questionId);
                if (result.success) {
                    alert('Question deleted successfully');
                    loadAdminData();
                } else {
                    alert('Error: ' + result.error);
                }
            }
        };

        window.adminDeleteAnswer = async function(answerId, questionId) {
            if (confirm('Are you sure you want to delete this answer?')) {
                const result = await deleteAnswer(answerId, questionId);
                if (result.success) {
                    alert('Answer deleted successfully');
                    loadAdminData();
                } else {
                    alert('Error: ' + result.error);
                }
            }
        };

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
