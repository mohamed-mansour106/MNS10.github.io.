<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´ØªØ±Ùƒ - Ù…ÙˆÙ‚Ø¹ÙŠ</title>
<link rel="stylesheet" href="style.css">
<style>
  /* ØªØ­Ø³ÙŠÙ† Ø³Ø±ÙŠØ¹ Ù„Ù„ØªØ®Ø·ÙŠØ· Ø¯Ø§Ø®Ù„ dashboard ÙÙ‚Ø· */
  .dashboard-wrap { max-width:1100px; margin:32px auto; display:flex; gap:24px; padding:0 16px; align-items:flex-start; }
  .panel { background:#fff; border-radius:12px; box-shadow:0 8px 30px rgba(15,23,42,0.08); padding:20px; }
  .profile { width:320px; flex-shrink:0; display:flex; flex-direction:column; gap:16px; }
  .profile .avatar { width:120px; height:120px; border-radius:16px; background:linear-gradient(135deg,var(--accent),var(--accent-dark)); color:#fff; display:flex; align-items:center; justify-content:center; font-size:1.6rem; font-weight:700; overflow:hidden; }
  .profile .avatar img { width:100%; height:100%; object-fit:cover; display:block; }
  .profile .avatar .initials { display:flex; align-items:center; justify-content:center; width:100%; height:100%; }
  .profile h3 { margin:0; font-size:1.25rem; }
  .profile p { margin:0; color:var(--text-secondary); font-size:0.95rem; }
  .profile .meta { display:flex; gap:8px; flex-wrap:wrap; color:var(--text-secondary); font-size:0.9rem; }
  .content { flex:1; display:flex; flex-direction:column; gap:16px; }
  .users-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:12px; }
  .user-card { padding:12px; border-radius:10px; border:1px solid var(--border); background:var(--light); }
  .user-avatar-sm { width:44px;height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;overflow:hidden;flex-shrink:0; }
  .user-avatar-sm img { width:100%;height:100%;object-fit:cover;display:block; }
  .top-row { display:flex; justify-content:space-between; gap:12px; align-items:center; margin-bottom:6px; }
  .welcome { font-size:1.1rem; font-weight:700; }
  .small-muted { color:var(--text-secondary); font-size:0.95rem; }
  @media (max-width:900px) {
    .dashboard-wrap { flex-direction:column; }
    .profile { width:100%; flex-direction:row; align-items:center; padding:12px; }
    .profile .avatar { width:72px; height:72px; border-radius:10px; font-size:1.1rem; }
  }
</style>
</head>
<body>
  <header class="nav">
    <a href="index.html" class="brand">Ù…ÙˆÙ‚Ø¹ÙŠ</a>
    <nav id="nav-auth"></nav>
  </header>
    <style>
    .main {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 20px;
        background-color: #f8f8f8;
    }
    .logo img {
        height: 50px;
    }
    .mmm106 p {
        margin: 0;
        line-height: 1.2;
    }
    .contain a {
        margin: 0 10px;
        text-decoration: none;
        color: #333;
        font-weight: bold;
    }
    .contain a:hover {
        color: #007BFF;
    } 
    
    </style>



<div class="main">
        <div class="logo">
            <img src="../photos/logo/MMM.png" alt="MMM Logo">
        </div>
        <div class="mmm106">
            <p><b>MMM106</b></p>
            <p><i><u>Educational Website</u></i></p>
        </div>
        
        

        <div class="contain">
            <a href="../index.html">Home</a>
            <a href="sign/signup.html">Sign Up</a>
            <a href="sign/login.html">Log In</a>
            <a href="#">News</a>
            <a href="#">MMM Team</a>
        </div>
    </div>

  <main class="card" style="max-width:1200px;margin:28px auto;">
    <div class="top-row" style="align-items:center;">
      <div>
        <h2 style="margin:0;">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´ØªØ±Ùƒ</h2>
        <p class="small-muted" style="margin:6px 0 0;">ØµÙØ­ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</p>
      </div>
      <div>
        <button id="logout" class="btn" style="min-width:140px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <div class="dashboard-wrap">
      <aside class="panel profile" aria-label="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù">
        <div style="display:flex;gap:16px;align-items:center;">
          <div id="avatar" class="avatar" aria-hidden="true">
            <img id="avatarImg" alt="avatar" style="display:none;">
            <span id="avatarInitials" class="initials">..</span>
          </div>
          <div>
            <h3 id="displayName">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>
            <p id="displayEmail" class="small-muted"></p>
          </div>
        </div>

        <div>
          <div class="small-muted">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</div>
          <div class="meta" id="profileMeta">
            <span id="metaPhone"></span>
            <span id="metaCity"></span>
            <span id="metaDob"></span>
          </div>
        </div>

        <div>
          <div class="small-muted">Ø­ÙˆÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</div>
          <p id="createdAt" class="small-muted" style="margin-top:6px;"></p>
        </div>
      </aside>

      <section class="content">
        <div class="panel">
          <div id="info" class="welcome">Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...</div>
        </div>

        <div class="panel">
          <h3 style="margin:0 0 12px 0;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h3>
          <div id="usersList" class="users-grid">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
      </section>
    </div>
  </main>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script src="firebase-init.js"></script>
  <script>
    const info = document.getElementById('info');
    const usersList = document.getElementById('usersList');
    const logoutBtn = document.getElementById('logout');
    const displayNameEl = document.getElementById('displayName');
    const displayEmailEl = document.getElementById('displayEmail');
    const avatarEl = document.getElementById('avatar');
    const avatarImg = document.getElementById('avatarImg');
    const avatarInitials = document.getElementById('avatarInitials');
    const metaPhone = document.getElementById('metaPhone');
    const metaCity = document.getElementById('metaCity');
    const metaDob = document.getElementById('metaDob');
    const createdAtEl = document.getElementById('createdAt');

    function initials(name) {
      if (!name) return '';
      const parts = name.trim().split(/\s+/);
      return (parts[0][0] || '').toUpperCase() + (parts[1] ? parts[1][0].toUpperCase() : '');
    }

    firebase.auth().onAuthStateChanged(async user => {
      if (!user) { location.href = 'login.html'; return; }

      try {
        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Auth Ùˆ Firestore
        const userDocSnap = await firebase.firestore().collection('users').doc(user.uid).get();
        const userData = userDocSnap.exists ? userDocSnap.data() : {};

        // Ù†ÙØ¶Ù‘Ù„ username Ù…Ù† Firestore Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… displayName Ù…Ù† AuthØŒ Ø«Ù… Ø§Ù„Ø¨Ø±ÙŠØ¯
        const usernameFromDoc = userData.username || null;
        const fallbackName = user.displayName || user.email || user.uid;
        const shownName = usernameFromDoc || fallbackName;

        // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù† ÙˆÙØ¬Ø¯Øª (Firestore.photoURL Ø£Ùˆ Auth.photoURL)
        const photoURL = userData.photoURL || user.photoURL || '';

        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙÙŠ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„)
        displayNameEl.textContent = shownName;
        displayEmailEl.textContent = user.email || '';

        if (photoURL) {
          avatarImg.src = photoURL;
          avatarImg.style.display = 'block';
          avatarInitials.style.display = 'none';
        } else {
          avatarImg.style.display = 'none';
          avatarInitials.style.display = 'flex';
          avatarInitials.textContent = initials(usernameFromDoc || user.displayName || user.email || user.uid) || '..';
        }

        metaPhone.textContent = userData.phone ? 'ğŸ“ ' + userData.phone : '';
        metaCity.textContent = userData.city ? 'ğŸ™ï¸ ' + userData.city : '';
        metaDob.textContent = userData.dob ? 'ğŸ‚ ' + userData.dob : '';
        createdAtEl.textContent = userData.createdAt ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ' + new Date(userData.createdAt).toLocaleString('ar-EG') : '';

        // Ø§Ù„Ø¢Ù† Ù†Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ù€ info Ø§Ø³Ù… Ø§Ù„Ù€ username Ø¥Ù† ÙˆÙØ¬Ø¯ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        if (usernameFromDoc) {
          info.innerHTML = `<span>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ</span> <strong style="margin-inline-start:8px;">${usernameFromDoc}!</strong> <span class="small-muted" style="display:block;margin-top:6px;">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ùƒ ÙˆØ±Ø¤ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù‡Ù†Ø§</span>`;
        } else {
          info.innerHTML = `<span>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ</span> <strong style="margin-inline-start:8px;">${shownName}</strong> <span class="small-muted" style="display:block;margin-top:6px;">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ùƒ ÙˆØ±Ø¤ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù‡Ù†Ø§</span>`;
        }

      } catch (e) {
        // Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨Ø³ÙŠØ· Ø¹Ù†Ø¯ Ø­Ø¯ÙˆØ« Ø®Ø·Ø£
        displayNameEl.textContent = user.displayName || user.email || user.uid;
        displayEmailEl.textContent = user.email || '';
        avatarImg.style.display = 'none';
        avatarInitials.style.display = 'flex';
        avatarInitials.textContent = initials(user.displayName || user.email) || '..';
        info.textContent = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ' + (user.displayName || user.email || user.uid);
      }

      // Ø¬Ù„Ø¨ Ø£ÙˆÙ„ 20 Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firestore (collection "users")
      try {
        const snapshot = await firebase.firestore().collection('users').orderBy('createdAt','desc').limit(20).get();
        usersList.innerHTML = '';
        snapshot.forEach(doc => {
          const d = doc.data();
          const card = document.createElement('div');
          card.className = 'user-card';

          // avatar ØµØºÙŠØ± Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…: ØµÙˆØ±Ø© Ø¥Ù† WÙØ¬Ø¯Øª ÙˆØ¥Ù„Ø§ Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ø£ÙˆÙ„Ù‰
          const userAvatarHtml = d.photoURL
            ? `<div class="user-avatar-sm" style="background:transparent;"><img src="${d.photoURL}" alt="u"></div>`
            : `<div class="user-avatar-sm" style="background:linear-gradient(135deg,var(--accent),var(--accent-dark));">${(d.username||d.email||'').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase()}</div>`;

          card.innerHTML = `
            <div style="display:flex;align-items:center;gap:10px;">
              ${userAvatarHtml}
              <div>
                <div style="font-weight:700;">${d.username || d.email}</div>
                <div class="small-muted" style="font-size:0.85rem;">${d.city || ''}</div>
              </div>
            </div>
          `;
          usersList.appendChild(card);
        });
        if (!usersList.innerHTML) usersList.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙƒÙŠÙ†.';
      } catch (e) {
        usersList.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£: ' + e.message;
      }
    });

    logoutBtn.addEventListener('click', () => {
      firebase.auth().signOut().then(()=> location.href = 'index.html');
    });
  </script>
</body>
</html>
